<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ç¾½çƒæˆ°è¡“è¨è«–æ¿</title>
<style>
  /* ===== å¯æ„›ç²‰å½©ä¸»é¡Œ ===== */
  :root{
    --bg:#fff7fb; --bg-accent:#ffeef7; --panel:#ffffff; --panel-2:#fff5fb;
    --ink:#54485f; --muted:#8a7b96; --primary:#fe7fbf; --primary-2:#ff9fd1; --primary-3:#ffb9de;
    --green:#7bd6c5; --blue:#8ec6ff; --yellow:#ffd972; --purple:#bfa9ff;
    --shadow:0 8px 24px rgba(255,127,191,.25);
    --ring:0 0 0 3px rgba(255,127,191,.25);
    --net-band:#8b6fb2;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    display:grid;grid-template-rows:auto auto 1fr;background:
      radial-gradient(1200px 700px at 10% -10%, #ffdbee 0%, transparent 60%),
      radial-gradient(1000px 700px at 110% 10%, #e8f6ff 0%, transparent 55%),
      var(--bg);
    color:var(--ink);
    font-family: ui-rounded, "SF Pro Rounded", system-ui, "Noto Sans TC", sans-serif;
    overflow:hidden;
  }

  /* ===== é ‚éƒ¨å·¥å…·åˆ— ===== */
  header{
    position:sticky; top:0; z-index:5;
    display:flex; flex-wrap:wrap; align-items:center; gap:10px 12px;
    padding:10px 14px;
    background:linear-gradient(180deg,var(--bg-accent),rgba(255,255,255,.85));
    backdrop-filter:saturate(1.2) blur(10px);
    border-bottom:1px solid #f4e4ef;
  }
  .brand{
    display:flex; align-items:center; gap:10px; padding:6px 10px;
    background:var(--panel); border:1px solid #f3dbe9; border-radius:999px; box-shadow:var(--shadow);
  }
  .brand .logo{ width:26px;height:26px;border-radius:50%;
    background: conic-gradient(from 0deg, var(--primary), var(--blue), var(--green), var(--primary));
    box-shadow: inset 0 0 0 3px #fff, 0 6px 16px rgba(0,0,0,.08);
  }
  .brand h1{font-size:15px; margin:0; font-weight:700; letter-spacing:.4px}

  .toolbar{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    background:var(--panel); border:1px solid #f3dbe9; border-radius:22px;
    padding:8px; box-shadow:var(--shadow);
  }

  /* è† å›Šåˆ‡æ›ï¼šå–®/é›™æ‰“ */
  .pill{
    display:flex; align-items:center; background:var(--panel-2);
    border:1px solid #f6e5f1; border-radius:999px; padding:4px; gap:4px;
  }
  .pill input{ display:none; }
  .pill label{
    cursor:pointer; padding:8px 14px; border-radius:999px; font-size:13px;
    color:var(--muted); transition:all .2s ease; user-select:none;
  }
  .pill input:checked + label{
    color:#fff; background:linear-gradient(180deg,var(--primary),var(--primary-2));
    box-shadow:var(--ring);
  }
  .sep{ width:1px; height:28px; background:#f1e3ef; margin:0 2px; }

  /* ===== è»Ÿç³–æŒ‰éˆ• + æœå‡å½ˆè·³ ===== */
  .btn{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 14px; border-radius:14px; font-size:14px; font-weight:600;
    border:1px solid #f0dbec; background:var(--panel);
    color:var(--ink); cursor:pointer; transition:box-shadow .2s ease, background .2s;
    box-shadow:var(--shadow); will-change:transform; user-select:none;
  }
  .btn:hover{ box-shadow: 0 10px 26px rgba(255,127,191,.32); }
  .btn:active{ transform: translateY(1px); }
  .btn.primary{ background:linear-gradient(180deg,var(--primary-2),var(--primary)); color:#fff; border-color:#ffb6da; }
  .btn.green  { background:linear-gradient(180deg,#9fe8d8,#61d4bd); color:#07453d; border-color:#b4efe2; }
  .btn.blue   { background:linear-gradient(180deg,#bfe0ff,#8ec6ff); color:#06304e; border-color:#cbe6ff; }
  .btn.purple { background:linear-gradient(180deg,#d8c6ff,#bfa9ff); color:#3f2b75; border-color:#e6d9ff; }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; box-shadow:none; }

  /* è§¸ç™¼æ™‚çš„æœå‡å‹•ç•«ï¼ˆæŒ‰éˆ•/æ£‹å­/é€²åº¦æ»‘æ¡¿æ‹‡æŒ‡å…±ç”¨ï¼‰ */
  @keyframes jelly {
    0%   { transform: scale3d(1,1,1); }
    20%  { transform: scale3d(0.95,1.06,1); }
    40%  { transform: scale3d(1.06,0.95,1); }
    60%  { transform: scale3d(0.98,1.02,1); }
    80%  { transform: scale3d(1.02,0.99,1); }
    100% { transform: scale3d(1,1,1); }
  }
  .jelly-bounce{ animation: jelly 420ms cubic-bezier(.2,.8,.2,1); }
  @media (prefers-reduced-motion: reduce){
    .jelly-bounce{ animation:none; }
    .btn:active{ transform:none; }
  }

  /* ===== ç¬¬äºŒåˆ—ï¼šå›æ”¾æ§åˆ¶åˆ—ï¼ˆé€²åº¦æ¢ï¼‰ ===== */
  .playerbar{
    display:flex; align-items:center; gap:10px; padding:8px 14px;
    background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.72));
    border-bottom:1px solid #f4e4ef;
    position:sticky; top:58px; z-index:4;
  }
  .playerbar .label{ font-size:13px; color:#6c5c7a; min-width:54px; }
  .time{ font-variant-numeric: tabular-nums; font-size:12px; color:#8a7b96; min-width:76px; text-align:center; }
  .range{
    flex:1; display:flex; align-items:center; gap:8px;
    padding:8px 10px; border-radius:14px; background:#fff; border:1px solid #f0dbec; box-shadow:var(--shadow);
  }
  input[type="range"]{
    -webkit-appearance:none; appearance:none; width:100%; height:10px; border-radius:999px;
    background: linear-gradient(90deg, var(--primary) var(--p,0%), #eee var(--p,0%));
    outline:none;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #fff 0 40%, var(--primary) 41% 100%);
    border:2px solid #ffd1ea; box-shadow:0 2px 8px rgba(254,127,191,.35);
    cursor:pointer; transition:transform .1s ease;
  }
  input[type="range"]::-moz-range-thumb{
    width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #ffd1ea; cursor:pointer;
  }

  /* ===== å·¥ä½œå€ ===== */
  .stage-wrap{ position:relative; min-height:0; padding:12px; }
  .stage{
    height:100%; width:100%; border-radius:24px; background:var(--panel);
    border:1px dashed #f1e0ed; box-shadow:var(--shadow);
    display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
  }
  .board{
    background:linear-gradient(180deg,#fef6fb,#fff); border-radius:22px;
    border:1px solid #f4e4ef; box-shadow: inset 0 0 0 1px #f8eff5;
    display:flex; align-items:center; justify-content:center; position:relative;
  }
  svg{ width:96%; height:96%; display:block; touch-action:none }
  .draggable{ cursor:grab }
  .dragging{ cursor:grabbing; filter:drop-shadow(0 8px 14px rgba(0,0,0,.18)); }

  .overlay{ position:absolute; inset:0; background:rgba(255,182,213,.12); display:none }
  .overlay.playing{ display:block; animation: pulse 1.1s ease-in-out infinite alternate; }
  @keyframes pulse{ from{background:rgba(255,182,213,.10)} to{background:rgba(255,182,213,.18)} }

  .copyright{
    position:absolute; right:12px; bottom:8px; font-size:12px; color:#9b8aa9; opacity:.85;
    background:rgba(255,255,255,.7); border:1px solid #efdeea; padding:4px 10px; border-radius:999px;
    backdrop-filter: blur(4px);
  }

  /* æ—‹è½‰ç‹€æ…‹ä¸‹è®“ icon åå‘æ—‹è½‰ï¼Œé¿å…é ­ä¸‹è…³ä¸Š */
  .icon{ transform-box: fill-box; transform-origin: center; }
  .rot-on .icon{ transform: rotate(-90deg); }
</style>
</head>
<body>
  <!-- ===== Headerï¼šå“ç‰Œ + å·¥å…·åˆ— ===== -->
  <header id="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>ç¾½çƒæˆ°è¡“è¨è«–æ¿</h1>
    </div>

    <div class="toolbar" role="group" aria-label="æ¨¡å¼èˆ‡æ“ä½œ">
      <!-- è† å›Šåˆ‡æ› å–®/é›™æ‰“ -->
      <div class="pill" role="tablist" aria-label="æ¯”è³½æ¨¡å¼">
        <input type="radio" id="md-s" name="mode" value="singles">
        <label for="md-s">ğŸƒâ€â™‚ï¸ å–®æ‰“</label>
        <input type="radio" id="md-d" name="mode" value="doubles" checked>
        <label for="md-d">ğŸ‘« é›™æ‰“</label>
      </div>

      <span class="sep"></span>

      <button id="resetBtn" class="btn" title="é‡ç½®ä½ç½®">ğŸ”„ é‡ç½®</button>
      <button id="rotateBtn" class="btn blue" title="æ—‹è½‰ 90Â° æª¢è¦–">ğŸŒ€ æ—‹è½‰90Â°</button>
      <button id="fsBtn"     class="btn purple" title="å…¨è¢å¹•åˆ‡æ›">â›¶ å…¨è¢å¹•</button>

      <span class="sep"></span>

      <button id="recStartBtn" class="btn primary">âºï¸ é–‹å§‹è¨˜éŒ„</button>
      <button id="recStopBtn"  class="btn" disabled>â¹ï¸ çµæŸè¨˜éŒ„</button>
      <button id="playBtn"     class="btn green" disabled>â–¶ï¸ å›æ”¾</button>
      <button id="pauseBtn"    class="btn" disabled>â¸ï¸ æš«åœ</button>
      <button id="stopBtn"     class="btn" disabled>â¹ï¸ åœæ­¢</button>
    </div>
  </header>

  <!-- ===== Player barï¼šå›æ”¾é€²åº¦æ¢ ===== -->
  <div class="playerbar">
    <div class="label">å›æ”¾</div>
    <div class="range" style="flex:1">
      <span class="time" id="curTime">00:00.0</span>
      <input id="progress" type="range" min="0" value="0" step="1" />
      <span class="time" id="totTime">00:00.0</span>
    </div>
  </div>

  <!-- ===== å·¥ä½œå€ ===== -->
  <div class="stage-wrap">
    <div class="stage" id="stage">
      <div class="board" id="board" tabindex="-1" aria-label="æˆ°è¡“æ¿">
        <div class="overlay" id="playOverlay" title="æ’­æ”¾ä¸­â€¦"></div>

        <!-- æ—‹è½‰æ™‚åªè½‰ worldï¼Œä¸¦åˆ‡æ› viewBoxï¼ˆç›´â†”æ©«ï¼‰ -->
        <svg id="court" viewBox="0 0 6500 13800" aria-label="Badminton Court" preserveAspectRatio="xMidYMid meet">
          <g id="world" transform="">
            <defs>
              <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#aaf0e3"/><stop offset="100%" stop-color="#7bd6c5"/>
              </linearGradient>
              <pattern id="netgrid" width="140" height="140" patternUnits="userSpaceOnUse">
                <path d="M0 0H140M0 0V140" stroke="#ffffff" stroke-opacity=".85" stroke-width="10"/>
              </pattern>
            </defs>

            <!-- å ´åœ° -->
            <rect x="200" y="200" width="6100" height="13400" rx="28" fill="url(#g)" />
            <g stroke="#ffffff" stroke-opacity=".96" stroke-width="60" fill="none">
              <rect x="200" y="200" width="6100" height="13400" rx="28"/>
              <rect x="660" y="200" width="5180" height="13400" rx="16"/>
              <line x1="200" y1="4920" x2="6300" y2="4920"/>
              <line x1="200" y1="8880" x2="6300" y2="8880"/>
              <line x1="200" y1="960"  x2="6300" y2="960"/>
              <line x1="200" y1="12840" x2="6300" y2="12840"/>
              <line x1="3250" y1="200"  x2="3250" y2="4920"/>
              <line x1="3250" y1="8880" x2="3250" y2="13600"/>
            </g>

            <!-- ç¶²å¸¶ï¼ˆåŠ æ·±ï¼‰ -->
            <g id="net">
              <rect x="200" y="6770" width="6100" height="260" fill="var(--net-band)" opacity="1"/>
              <rect x="200" y="6770" width="6100" height="260" fill="url(#netgrid)" opacity=".75"/>
              <rect x="200" y="6760" width="6100" height="40" fill="#fff"/>
            </g>

            <!-- AéšŠ -->
            <g id="A1" class="draggable" data-role="A1" transform="translate(3250,10800)">
              <g class="icon"><image x="-450" y="-450" width="900" height="900" href="red.png" xlink:href="red.png"/></g>
            </g>
            <g id="A2" class="draggable" data-role="A2" transform="translate(3250,9000)">
              <g class="icon"><image x="-450" y="-450" width="900" height="900" href="red.png" xlink:href="red.png"/></g>
            </g>

            <!-- BéšŠ -->
            <g id="B1" class="draggable" data-role="B1" transform="translate(3250,4800)">
              <g class="icon"><image x="-450" y="-450" width="900" height="900" href="blue.png" xlink:href="blue.png"/></g>
            </g>
            <g id="B2" class="draggable" data-role="B2" transform="translate(3250,3200)">
              <g class="icon"><image x="-450" y="-450" width="900" height="900" href="blue.png" xlink:href="blue.png"/></g>
            </g>

            <!-- ç¾½çƒ -->
            <g id="SHUTTLE" class="draggable" data-role="S" transform="translate(3250,6500)">
              <g class="icon"><image x="-500" y="-500" width="1000" height="1000" href="shuttle.png" xlink:href="shuttle.png"/></g>
            </g>
          </g>
        </svg>

        <div class="copyright">Design by Kunta</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const VB_W=6500, VB_H=13800;
  const topbar=document.getElementById('topbar');
  const board =document.getElementById('board');
  const stage =document.getElementById('stage');
  const svg   =document.getElementById('court');
  const world =document.getElementById('world');
  const playOverlay=document.getElementById('playOverlay');

  // æ¨¡å¼åˆ‡æ›ï¼ˆè† å›Šï¼‰
  const modeSingles=document.getElementById('md-s');
  const modeDoubles=document.getElementById('md-d');

  const resetBtn   =document.getElementById('resetBtn');
  const rotateBtn  =document.getElementById('rotateBtn');
  const fsBtn      =document.getElementById('fsBtn');
  const recStartBtn=document.getElementById('recStartBtn');
  const recStopBtn =document.getElementById('recStopBtn');
  const playBtn    =document.getElementById('playBtn');
  const pauseBtn   =document.getElementById('pauseBtn');
  const stopBtn    =document.getElementById('stopBtn');

  // é€²åº¦åˆ—
  const progress   =document.getElementById('progress');
  const curTimeEl  =document.getElementById('curTime');
  const totTimeEl  =document.getElementById('totTime');

  // æŒ‰éˆ•æœå‡å‹•ç•«ï¼ˆclickï¼‰
  document.querySelectorAll('.btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{ if(btn.disabled) return; triggerJelly(btn); });
    btn.addEventListener('animationend', ()=> btn.classList.remove('jelly-bounce'));
  });

  // è‡ªé©æ‡‰å¤§å°ï¼šä¾ç›®å‰ viewBox æ¯”ä¾‹
  function fitBoard(){
    const vb=svg.viewBox.baseVal;
    const ratio=vb.height/vb.width;
    const availH=window.innerHeight - topbar.offsetHeight - document.querySelector('.playerbar').offsetHeight - 20;
    const availW=document.documentElement.clientWidth - 24;
    const hFromW=availW * ratio;
    const wFromH=availH / ratio;
    board.style.height = Math.min(availH, hFromW) + "px";
    board.style.width  = Math.min(availW, wFromH) + "px";
  }
  window.addEventListener('resize', fitBoard);
  window.addEventListener('orientationchange', ()=> setTimeout(fitBoard,60));
  document.addEventListener('fullscreenchange', ()=>{
    fsBtn.textContent = document.fullscreenElement ? 'â›¶ é€€å‡ºå…¨è¢å¹•' : 'â›¶ å…¨è¢å¹•';
    fitBoard();
  });
  fitBoard();

  // ç‹€æ…‹
  const BOUNDS={xMin:200,yMin:200,xMax:6300,yMax:13600};
  const RAD={piece:450, shuttle:500};
  const defaults={
    singles:{A1:{x:3250,y:10800},B1:{x:3250,y:3000},S:{x:3250,y:6500}},
    doubles:{A1:{x:3250,y:10800},A2:{x:3250,y:9000},B1:{x:3250,y:4800},B2:{x:3250,y:3200},S:{x:3250,y:6500}}
  };
  let state={mode:'doubles',positions:clone(defaults.doubles),rotated:false};

  // è¨˜éŒ„è³‡æ–™
  let recording=false, steps=[], startSnapshot=null;

  // å›æ”¾è³‡æ–™ï¼ˆæ–°ï¼šæ™‚é–“è»¸ï¼‰
  let isPlaying=false, isPaused=false;
  let timeline=null;            // {segments:[{t0,t1,role,from,to,mode}], total}
  let playStartStamp=0;         // raf é–‹å§‹æ™‚çš„ performance.now()
  let baseElapsed=0;            // æš«åœæ™‚ä¿ç•™çš„å·²éæ™‚é–“
  let rafId=null;

  // åˆå§‹åŒ–
  modeDoubles.checked=true; renderMode(state.mode); renderPositions();

  // æ¨¡å¼åˆ‡æ›
  modeSingles.addEventListener('change', ()=>{ if(modeSingles.checked) setMode('singles'); });
  modeDoubles.addEventListener('change', ()=>{ if(modeDoubles.checked) setMode('doubles'); });
  function setMode(m){
    state.mode = m==='singles'?'singles':'doubles';
    state.positions = clone(defaults[state.mode]);
    renderMode(state.mode); renderPositions(true);
  }
  function renderMode(m){
    const showPair = (m==='doubles');
    document.getElementById('A2').style.display = showPair?'':'none';
    document.getElementById('B2').style.display = showPair?'':'none';
  }

  // é‡ç½®
  resetBtn.addEventListener('click', ()=>{
    state.positions = clone(defaults[state.mode]); renderPositions(true);
    flash(resetBtn);
  });

  // æ—‹è½‰ 90Â°ï¼ˆåˆ‡ viewBoxï¼›icon åå‘æ—‹è½‰ä¿æŒæ­£å‘ï¼‰
  rotateBtn.addEventListener('click', ()=>{
    state.rotated = !state.rotated;
    if(state.rotated){
      svg.setAttribute('viewBox', `0 0 ${VB_H} ${VB_W}`);
      world.setAttribute('transform', `translate(${VB_H} 0) rotate(90)`);
      document.documentElement.classList.add('rot-on');
    }else{
      svg.setAttribute('viewBox', `0 0 ${VB_W} ${VB_H}`);
      world.setAttribute('transform', ``);
      document.documentElement.classList.remove('rot-on');
    }
    fitBoard(); flash(rotateBtn);
  });

  // å…¨è¢å¹•ï¼ˆåˆ‡æ›æ•´å€‹æ–‡ä»¶ï¼Œä¿ç•™å·¥å…·åˆ—ï¼‰
  fsBtn.addEventListener('click', async ()=>{
    try{
      if(!document.fullscreenElement){
        await (document.documentElement.requestFullscreen?.() || document.documentElement.webkitRequestFullscreen?.());
      }else{
        await (document.exitFullscreen?.() || document.webkitExitFullscreen?.());
      }
      triggerJelly(fsBtn);
    }catch(e){ console.warn('å…¨è¢å¹•éŒ¯èª¤', e); }
  });

  // æ‹–æ›³ï¼ˆåŠ ã€Œæ”¾é–‹ã€æœå‡å›å½ˆï¼‰
  svg.querySelectorAll('.draggable').forEach(makeDraggable);
  function makeDraggable(el){
    el.style.touchAction='none';
    el.addEventListener('pointerdown', (e)=>{
      if(isPlaying) return; // æ’­æ”¾ä¸­ç¦æ­¢æ‰‹å‹•æ‹–æ‹‰
      e.preventDefault();
      el.setPointerCapture(e.pointerId);
      el.classList.add('dragging');

      const role = el.dataset.role;
      const start = getPt(e);
      const t = el.transform.baseVal.consolidate();
      const init = t ? {x:t.matrix.e, y:t.matrix.f} : {x:0, y:0};

      const move = (ev)=>{
        const p=getPt(ev);
        const nx=init.x + (p.x - start.x);
        const ny=init.y + (p.y - start.y);
        const c=clamp(nx,ny,role);
        state.positions[role]=c;
        setPos(el,c.x,c.y);
      };
      const up = ()=>{
        el.releasePointerCapture(e.pointerId);
        el.classList.remove('dragging');
        svg.removeEventListener('pointermove', move);
        svg.removeEventListener('pointerup', up);
        svg.removeEventListener('pointercancel', up);

        const icon = el.querySelector('.icon');
        if(icon){ triggerJelly(icon); }

        if(recording){
          steps.push({ role, from:{...init}, to:{...state.positions[role]}, mode: state.mode });
          playBtn.disabled = steps.length===0;
        }
      };

      svg.addEventListener('pointermove', move);
      svg.addEventListener('pointerup', up, { once:true });
      svg.addEventListener('pointercancel', up, { once:true });
    });
  }

  function getPt(e){
    const pt=svg.createSVGPoint(); pt.x=e.clientX; pt.y=e.clientY;
    const m = world.getScreenCTM().inverse();
    return pt.matrixTransform(m);
  }
  function clamp(x,y,role){
    const r=(role==='S')?RAD.shuttle:RAD.piece;
    return { x: Math.min(BOUNDS.xMax - r, Math.max(BOUNDS.xMin + r, x)),
             y: Math.min(BOUNDS.yMax - r, Math.max(BOUNDS.yMin + r, y)) };
  }
  function setPos(el,x,y){ el.setAttribute('transform',`translate(${x},${y})`); }
  function renderPositions(){
    ['A1','A2','B1','B2','S'].forEach(id=>{
      const el=document.getElementById(id==='S'?'SHUTTLE':id);
      if(!el) return;
      if(state.mode==='singles'&&(id==='A2'||id==='B2')){ el.style.display='none'; return; }
      el.style.display='';
      const p=state.positions[id]||defaults[state.mode][id];
      setPos(el,p.x,p.y);
    });
  }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }

  /* ========= è¨˜éŒ„ ========= */
  recStartBtn.addEventListener('click', ()=>{
    if(isPlaying) return;
    steps=[]; recording=true;
    startSnapshot={ mode: state.mode, positions: clone(state.positions) };
    recStartBtn.disabled=true; recStopBtn.disabled=false; playBtn.disabled=true;
    pauseBtn.disabled=stopBtn.disabled=true;
    flash(recStartBtn);
  });
  recStopBtn.addEventListener('click', ()=>{
    recording=false;
    recStartBtn.disabled=false; recStopBtn.disabled=true; playBtn.disabled=steps.length===0;
    pauseBtn.disabled=stopBtn.disabled=true;
    flash(recStopBtn);
  });

  /* ========= å›æ”¾ï¼ˆæ™‚é–“è»¸ç‰ˆï¼šæ”¯æ´æš«åœ/æ‹–æ›³/åœæ­¢ï¼‰ ========= */
  playBtn.addEventListener('click', ()=>{
    if(steps.length===0) return;
    if(!timeline) buildTimeline();
    isPlaying=true; isPaused=false;
    enableDuringPlay(true);
    playOverlay.classList.add('playing');
    playStartStamp=performance.now();
    rafId=requestAnimationFrame(tick);
    triggerJelly(playBtn);
  });

  pauseBtn.addEventListener('click', ()=>{
    if(!isPlaying) return;
    isPaused=!isPaused;
    if(isPaused){
      baseElapsed = getElapsed();
      cancelAnimationFrame(rafId);
      pauseBtn.textContent='â–¶ï¸ ç¹¼çºŒ';
    }else{
      playStartStamp = performance.now();
      rafId = requestAnimationFrame(tick);
      pauseBtn.textContent='â¸ï¸ æš«åœ';
    }
    triggerJelly(pauseBtn);
  });

  stopBtn.addEventListener('click', stopPlayback);

  // é€²åº¦æ¢ï¼šæ‹–æ›³/é»æ“Šå³æ™‚å®šä½
  progress.addEventListener('input', ()=>{
    if(!timeline) return;
    const t = Number(progress.value);
    setAt(t);
    updateTimeLabels(t, timeline.total);
    // jelly on thumb (å°è¶£å‘³)
    triggerJelly(progress);
  });

  function stopPlayback(){
    if(!timeline) return;
    isPlaying=false; isPaused=false;
    cancelAnimationFrame(rafId);
    playOverlay.classList.remove('playing');
    enableDuringPlay(false);
    // å›åˆ°èµ·å§‹ç«™ä½
    if(startSnapshot){
      state.mode=startSnapshot.mode; renderMode(state.mode);
      state.positions=clone(startSnapshot.positions); renderPositions(true);
    }
    baseElapsed=0; progress.value=0; progress.style.setProperty('--p','0%');
    updateTimeLabels(0, timeline.total);
    pauseBtn.textContent='â¸ï¸ æš«åœ';
    triggerJelly(stopBtn);
  }

  function enableDuringPlay(playing){
    playBtn.disabled = playing;   // æ’­æ”¾æ™‚é—œé–‰ã€Œæ’­æ”¾ã€éµ
    pauseBtn.disabled= !playing;  // å¯æš«åœ
    stopBtn.disabled = !playing;  // å¯åœæ­¢
    // å…è¨±å…¨è¢å¹• / æ—‹è½‰ / æ¨¡å¼åˆ‡æ› / é‡ç½®ï¼šç…§å¸¸å¯ç”¨ï¼ˆä½ è‹¥æƒ³æ’­æ”¾æ™‚é–å®šï¼Œå¯æ”¹ç‚º disabledï¼‰
    recStartBtn.disabled = true;  // æ’­æ”¾æ™‚ä¸å…è¨±é–‹å§‹æ–°è¨˜éŒ„
    recStopBtn.disabled  = true;
  }

  function buildTimeline(){
    // è¨ˆç®—æ¯æ­¥çš„æ™‚é–“ï¼ˆèˆ‡èˆŠç‰ˆä¸€è‡´çš„è·é›¢æ˜ å°„ï¼‰
    const segments=[];
    let t=0;
    let lastMode = startSnapshot? startSnapshot.mode : state.mode;
    const posAtStart = startSnapshot? clone(startSnapshot.positions) : clone(state.positions);

    // åˆå§‹ç‚ºèµ·é»ï¼ˆä¸ç”Ÿæˆ segmentï¼‰
    steps.forEach(step=>{
      const from = step.from, to = step.to;
      const dist = Math.hypot(to.x-from.x, to.y-from.y);
      const dur  = Math.max(250, 600*(dist/1800)); // ms
      segments.push({t0:t, t1:t+dur, role:step.role, from, to, mode:step.mode});
      t += dur;
      lastMode = step.mode;
    });

    timeline = {segments, total: t, startPositions: posAtStart, startMode: startSnapshot? startSnapshot.mode : state.mode};
    // æ›´æ–° UI
    progress.max = Math.max(1, Math.round(t));
    progress.value = 0;
    progress.style.setProperty('--p','0%');
    updateTimeLabels(0,t);
  }

  function tick(now){
    const elapsed = getElapsed(now);
    if(elapsed>=timeline.total){
      setAt(timeline.total); // æ’­æ”¾åˆ°å°¾
      updateTimeLabels(timeline.total, timeline.total);
      stopPlayback();
      return;
    }
    setAt(elapsed);
    updateTimeLabels(elapsed, timeline.total);
    rafId=requestAnimationFrame(tick);
  }

  function getElapsed(now){
    if(isPaused) return baseElapsed;
    if(!now) now=performance.now();
    return baseElapsed + (now - playStartStamp);
  }

  function setAt(timeMs){
    // è¨­å®šæ¨¡å¼ & ä½ç½®ï¼ˆæŒ‰æ®µè½æ’å€¼ï¼‰
    let currentMode = timeline.startMode;
    const pos = clone(timeline.startPositions);

    for(const seg of timeline.segments){
      if(timeMs>=seg.t1){
        // å®Œæˆæ­¤æ®µ
        pos[seg.role] = {...seg.to};
        currentMode = seg.mode;
        continue;
      }else if(timeMs>=seg.t0 && timeMs<seg.t1){
        // æ­£åœ¨æ­¤æ®µ
        const p = (timeMs - seg.t0) / (seg.t1 - seg.t0);
        const e = p<.5? 2*p*p : 1-Math.pow(-2*p+2,2)/2; // ease
        pos[seg.role] = { x: seg.from.x + (seg.to.x-seg.from.x)*e,
                          y: seg.from.y + (seg.to.y-seg.from.y)*e };
        currentMode = seg.mode;
        break; // å¾Œé¢æ®µå°šæœªé–‹å§‹
      }else{
        // å°šæœªé–‹å§‹çš„æ®µï¼Œä¸å‹•
        break;
      }
    }

    state.mode = currentMode;
    renderMode(state.mode);
    // å¥—ç”¨åˆ° DOM
    ['A1','A2','B1','B2','S'].forEach(id=>{
      if(state.mode==='singles'&&(id==='A2'||id==='B2')) return;
      const el=document.getElementById(id==='S'?'SHUTTLE':id);
      const p = pos[id] || state.positions[id] || defaults[state.mode][id];
      el && setPos(el,p.x,p.y);
    });

    // æ›´æ–° range èƒŒæ™¯ç™¾åˆ†æ¯”
    const pct = Math.max(0, Math.min(100, (timeMs / timeline.total)*100));
    progress.value = Math.round(timeMs);
    progress.style.setProperty('--p', pct + '%');
  }

  function updateTimeLabels(cur,total){
    curTimeEl.textContent = formatMs(cur);
    totTimeEl.textContent = formatMs(total);
  }
  function formatMs(ms){
    const t=Math.max(0, Math.round(ms));
    const m = Math.floor(t/60000);
    const s = Math.floor((t%60000)/1000);
    const d = Math.floor((t%1000)/100);
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${d}`;
  }

  // å°å‹•æ•ˆ
  function flash(el){
    el.animate([{boxShadow:'var(--shadow)'},{boxShadow:'0 0 0 6px rgba(255,127,191,.25)'}],
               {duration:220, direction:'alternate', iterations:2});
  }
  function triggerJelly(el){
    el.classList.remove('jelly-bounce');
    void el.offsetWidth; el.classList.add('jelly-bounce');
  }

})();
</script>
</body>
</html>
